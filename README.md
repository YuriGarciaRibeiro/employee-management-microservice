# Employee Management Microservices

Sistema distribu√≠do para cadastro e ativa√ß√£o de funcion√°rios utilizando .NET 9 (C#) e Clean Architecture.

## üèóÔ∏è Arquitetura

O sistema √© composto por 3 microsservi√ßos principais:

### 1. Microsservi√ßo de Cadastro
- API REST para CRUD de funcion√°rios
- Persist√™ncia de dados
- Envio de e-mails de notifica√ß√£o
- Publica√ß√£o de eventos para o barramento de mensagens

### 2. Microsservi√ßo de Ativa√ß√£o
- Consumo de fila RabbitMQ
- Ativa√ß√£o autom√°tica de funcion√°rios na data de in√≠cio
- Processamento em lotes (100 funcion√°rios por vez)
- Agendamento via Hangfire

### 3. Microsservi√ßo de Notifica√ß√µes
- Hub SignalR para notifica√ß√µes em tempo real
- Distribui√ß√£o de eventos para setores
- Notifica√ß√µes sobre novos funcion√°rios e altera√ß√µes

## üöÄ Stack Tecnol√≥gica

- **.NET 9.0** - Framework principal
- **Clean Architecture** - Padr√£o arquitetural
- **Entity Framework Core** - ORM
- **PostgreSQL** - Banco de dados
- **RabbitMQ** - Message broker
- **Hangfire** - Agendamento de jobs
- **SignalR** - Comunica√ß√£o em tempo real
- **ASP.NET Identity** - Autentica√ß√£o e autoriza√ß√£o
- **JWT** - Tokens de autentica√ß√£o com refresh token
- **Docker** - Containeriza√ß√£o
- **xUnit + Moq** - Testes unit√°rios
- **k6** - Testes de carga
- **SonarQube** - An√°lise de c√≥digo

## üìÅ Estrutura do Projeto

```
employee-management-microservice/
‚îú‚îÄ‚îÄ src/Services/
‚îÇ   ‚îú‚îÄ‚îÄ Cadastro/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmployeeManagement.Cadastro.Domain/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmployeeManagement.Cadastro.Application/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmployeeManagement.Cadastro.Infrastructure/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EmployeeManagement.Cadastro.API/
‚îÇ   ‚îú‚îÄ‚îÄ Ativacao/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmployeeManagement.Ativacao.Domain/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmployeeManagement.Ativacao.Application/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmployeeManagement.Ativacao.Infrastructure/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EmployeeManagement.Ativacao.Worker/
‚îÇ   ‚îî‚îÄ‚îÄ Notificacoes/
‚îÇ       ‚îú‚îÄ‚îÄ EmployeeManagement.Notificacoes.Domain/
‚îÇ       ‚îú‚îÄ‚îÄ EmployeeManagement.Notificacoes.Application/
‚îÇ       ‚îú‚îÄ‚îÄ EmployeeManagement.Notificacoes.Infrastructure/
‚îÇ       ‚îî‚îÄ‚îÄ EmployeeManagement.Notificacoes.API/
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ Cadastro.Tests/
‚îÇ   ‚îú‚îÄ‚îÄ Ativacao.Tests/
‚îÇ   ‚îî‚îÄ‚îÄ Notificacoes.Tests/
‚îî‚îÄ‚îÄ docker-compose.yml
```

## üìã Requisitos Funcionais

### Cadastro de Funcion√°rios
- Campos: Nome, Telefone, Data de In√≠cio, Setor, Situa√ß√£o (Ativo/Inativo)
- CRUD completo via API REST
- Valida√ß√µes de dados

### Listagem e Agrupamento
- Filtro por per√≠odo (range de datas)
- Agrupamento por setor
- Pagina√ß√£o de resultados

### Notifica√ß√£o por E-mail
- Envio autom√°tico ao cadastrar funcion√°rio
- Conte√∫do: dados do funcion√°rio e data de in√≠cio

### Eventos em Tempo Real
- SignalR para notifica√ß√£o de setores
- Eventos: novo funcion√°rio, altera√ß√£o de data de in√≠cio

### Ativa√ß√£o Autom√°tica
- Agendamento via Hangfire
- Ativa√ß√£o na data de in√≠cio
- Processamento em lotes de 100 para volume > 1000

## ‚ö° Como Executar

### Pr√©-requisitos
- .NET 9.0 SDK
- Docker e Docker Compose

### Executar com Docker Compose

1. Clone o reposit√≥rio
```bash
git clone https://github.com/seu-usuario/employee-management-microservice.git
cd employee-management-microservice
```

2. Inicie os servi√ßos de infraestrutura
```bash
docker-compose up -d
```

3. Aguarde os servi√ßos estarem prontos
- PostgreSQL: http://localhost:5432
- RabbitMQ Management: http://localhost:15672 (guest/guest)
- SonarQube: http://localhost:9000 (admin/admin)

### Executar Localmente

```bash
# Restaurar pacotes
dotnet restore

# Compilar
dotnet build

# Executar microsservi√ßo de Cadastro
dotnet run --project src/Services/Cadastro/EmployeeManagement.Cadastro.API

# Executar microsservi√ßo de Notifica√ß√µes
dotnet run --project src/Services/Notificacoes/EmployeeManagement.Notificacoes.API

# Executar Worker de Ativa√ß√£o
dotnet run --project src/Services/Ativacao/EmployeeManagement.Ativacao.Worker
```

## üìù Endpoints da API

### Base URLs
- **Cadastro API**: `http://localhost:5001/api`
- **Notifica√ß√µes API**: `http://localhost:5002/api`
- **Swagger UI**: `http://localhost:5001/swagger` (Cadastro) e `http://localhost:5002/swagger` (Notifica√ß√µes)

---

## üîê Autentica√ß√£o

Todos os endpoints (exceto `/auth/register` e `/auth/login`) requerem autentica√ß√£o via JWT Bearer token.

**Header obrigat√≥rio:**
```
Authorization: Bearer {seu_token_jwt}
```

### 1. Registrar Usu√°rio

**POST** `/api/auth/register`

Cria uma nova conta de usu√°rio.

**Request Body:**
```json
{
  "email": "usuario@example.com",
  "password": "SenhaForte@123"
}
```

**Response (201 Created):**
```json
{
  "message": "User registered successfully"
}
```

**Valida√ß√µes:**
- Email deve ser v√°lido
- Senha: m√≠nimo 8 caracteres, 1 mai√∫scula, 1 min√∫scula, 1 n√∫mero, 1 caractere especial

---

### 2. Login

**POST** `/api/auth/login`

Autentica um usu√°rio e retorna tokens JWT.

**Request Body:**
```json
{
  "email": "usuario@example.com",
  "password": "SenhaForte@123"
}
```

**Response (200 OK):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "a1b2c3d4e5f6g7h8i9j0...",
  "expiration": "2025-10-23T15:30:00Z"
}
```

**Campos:**
- `token`: JWT token para autentica√ß√£o (v√°lido por 1 hora)
- `refreshToken`: Token para renova√ß√£o (v√°lido por 7 dias)
- `expiration`: Data/hora de expira√ß√£o do token

---

### 3. Refresh Token

**POST** `/api/auth/refresh`

Renova o token JWT usando o refresh token.

**Request Body:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "a1b2c3d4e5f6g7h8i9j0..."
}
```

**Response (200 OK):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "k1l2m3n4o5p6q7r8s9t0...",
  "expiration": "2025-10-23T16:30:00Z"
}
```

---

## üë• Funcion√°rios (Employees)

### 4. Criar Funcion√°rio

**POST** `/api/employees`

Cria um novo funcion√°rio no sistema.

**Request Body:**
```json
{
  "name": "Jo√£o Silva Santos",
  "phone": "+5511987654321",
  "department": "TI",
  "startDate": "2025-11-15T08:00:00Z"
}
```

**Response (201 Created):**
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "name": "Jo√£o Silva Santos",
  "phone": "+5511987654321",
  "department": "TI",
  "startDate": "2025-11-15T08:00:00Z",
  "isActive": false,
  "createdAt": "2025-10-23T10:30:00Z",
  "updatedAt": "2025-10-23T10:30:00Z"
}
```

**Valida√ß√µes:**
- `name`: obrigat√≥rio, 3-200 caracteres
- `phone`: obrigat√≥rio, 10-15 d√≠gitos (formato: +5511987654321)
- `department`: obrigat√≥rio, 2-100 caracteres
- `startDate`: obrigat√≥rio, deve ser data futura

**Eventos gerados:**
- üìß Email de notifica√ß√£o enviado
- üì® Mensagem publicada no RabbitMQ
- üîî Notifica√ß√£o SignalR enviada para o departamento

---

### 5. Listar Todos os Funcion√°rios

**GET** `/api/employees?pageNumber=1&pageSize=10`

Lista todos os funcion√°rios com pagina√ß√£o.

**Query Parameters:**
- `pageNumber` (opcional, padr√£o: 1): N√∫mero da p√°gina
- `pageSize` (opcional, padr√£o: 10, m√°x: 100): Itens por p√°gina

**Response (200 OK):**
```json
{
  "items": [
    {
      "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
      "name": "Jo√£o Silva Santos",
      "phone": "+5511987654321",
      "department": "TI",
      "startDate": "2025-11-15T08:00:00Z",
      "isActive": false,
      "createdAt": "2025-10-23T10:30:00Z",
      "updatedAt": "2025-10-23T10:30:00Z"
    },
    {
      "id": "7bc92a41-8d15-4f2e-b9c7-1e4f5a6b8c9d",
      "name": "Maria Oliveira Costa",
      "phone": "+5511912345678",
      "department": "RH",
      "startDate": "2025-10-30T08:00:00Z",
      "isActive": false,
      "createdAt": "2025-10-23T11:00:00Z",
      "updatedAt": "2025-10-23T11:00:00Z"
    }
  ],
  "pageNumber": 1,
  "pageSize": 10,
  "totalPages": 5,
  "totalCount": 47,
  "hasPreviousPage": false,
  "hasNextPage": true
}
```

---

### 6. Buscar Funcion√°rio por ID

**GET** `/api/employees/{id}`

Retorna os detalhes de um funcion√°rio espec√≠fico.

**Path Parameter:**
- `id`: UUID do funcion√°rio

**Response (200 OK):**
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "name": "Jo√£o Silva Santos",
  "phone": "+5511987654321",
  "department": "TI",
  "startDate": "2025-11-15T08:00:00Z",
  "isActive": false,
  "createdAt": "2025-10-23T10:30:00Z",
  "updatedAt": "2025-10-23T10:30:00Z"
}
```

---

### 7. Atualizar Funcion√°rio

**PUT** `/api/employees/{id}`

Atualiza todos os dados de um funcion√°rio.

**Path Parameter:**
- `id`: UUID do funcion√°rio

**Request Body:**
```json
{
  "name": "Jo√£o Silva Santos Junior",
  "phone": "+5511999887766",
  "department": "Desenvolvimento",
  "startDate": "2025-11-20T08:00:00Z"
}
```

**Response (200 OK):**
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "name": "Jo√£o Silva Santos Junior",
  "phone": "+5511999887766",
  "department": "Desenvolvimento",
  "startDate": "2025-11-20T08:00:00Z",
  "isActive": false,
  "createdAt": "2025-10-23T10:30:00Z",
  "updatedAt": "2025-10-23T14:45:00Z"
}
```

---

### 8. Atualizar Data de In√≠cio

**PUT** `/api/employees/{id}/start-date`

Atualiza apenas a data de in√≠cio de um funcion√°rio.

**Path Parameter:**
- `id`: UUID do funcion√°rio

**Request Body:**
```json
{
  "startDate": "2025-12-01T08:00:00Z"
}
```

**Response (200 OK):**
```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "name": "Jo√£o Silva Santos",
  "phone": "+5511987654321",
  "department": "TI",
  "startDate": "2025-12-01T08:00:00Z",
  "isActive": false,
  "createdAt": "2025-10-23T10:30:00Z",
  "updatedAt": "2025-10-23T15:00:00Z"
}
```

**Eventos gerados:**
- üîî Notifica√ß√£o SignalR sobre altera√ß√£o de data
- üì® Mensagem atualizada no RabbitMQ

---

### 9. Deletar Funcion√°rio

**DELETE** `/api/employees/{id}`

Remove um funcion√°rio do sistema (soft delete).

**Path Parameter:**
- `id`: UUID do funcion√°rio

**Response (204 No Content)**

---

## üìä Consultas e Relat√≥rios

### 10. Funcion√°rios por Per√≠odo

**GET** `/api/employees/by-date-range?startDate={start}&endDate={end}`

Retorna funcion√°rios com data de in√≠cio dentro do per√≠odo especificado.

**Query Parameters:**
- `startDate` (obrigat√≥rio): Data inicial (formato ISO 8601)
- `endDate` (obrigat√≥rio): Data final (formato ISO 8601)

**Exemplo:**
```
GET /api/employees/by-date-range?startDate=2025-11-01T00:00:00Z&endDate=2025-11-30T23:59:59Z
```

**Response (200 OK):**
```json
[
  {
    "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "name": "Jo√£o Silva Santos",
    "phone": "+5511987654321",
    "department": "TI",
    "startDate": "2025-11-15T08:00:00Z",
    "isActive": false,
    "createdAt": "2025-10-23T10:30:00Z",
    "updatedAt": "2025-10-23T10:30:00Z"
  },
  {
    "id": "8cd43b52-9e26-5g3f-c0d8-2f5g6b7c9e0a",
    "name": "Pedro Souza Lima",
    "phone": "+5511923456789",
    "department": "Vendas",
    "startDate": "2025-11-22T08:00:00Z",
    "isActive": false,
    "createdAt": "2025-10-23T12:15:00Z",
    "updatedAt": "2025-10-23T12:15:00Z"
  }
]
```

---

### 11. Funcion√°rios Agrupados por Departamento

**GET** `/api/employees/grouped-by-department`

Retorna funcion√°rios agrupados por departamento.

**Response (200 OK):**
```json
{
  "TI": [
    {
      "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
      "name": "Jo√£o Silva Santos",
      "phone": "+5511987654321",
      "department": "TI",
      "startDate": "2025-11-15T08:00:00Z",
      "isActive": false,
      "createdAt": "2025-10-23T10:30:00Z",
      "updatedAt": "2025-10-23T10:30:00Z"
    },
    {
      "id": "4gb96c75-6828-5673-c4gd-3d074g77bgb7",
      "name": "Carlos Eduardo Ferreira",
      "phone": "+5511934567890",
      "department": "TI",
      "startDate": "2025-11-18T08:00:00Z",
      "isActive": false,
      "createdAt": "2025-10-23T13:00:00Z",
      "updatedAt": "2025-10-23T13:00:00Z"
    }
  ],
  "RH": [
    {
      "id": "7bc92a41-8d15-4f2e-b9c7-1e4f5a6b8c9d",
      "name": "Maria Oliveira Costa",
      "phone": "+5511912345678",
      "department": "RH",
      "startDate": "2025-10-30T08:00:00Z",
      "isActive": false,
      "createdAt": "2025-10-23T11:00:00Z",
      "updatedAt": "2025-10-23T11:00:00Z"
    }
  ],
  "Vendas": [
    {
      "id": "8cd43b52-9e26-5g3f-c0d8-2f5g6b7c9e0a",
      "name": "Pedro Souza Lima",
      "phone": "+5511923456789",
      "department": "Vendas",
      "startDate": "2025-11-22T08:00:00Z",
      "isActive": false,
      "createdAt": "2025-10-23T12:15:00Z",
      "updatedAt": "2025-10-23T12:15:00Z"
    }
  ]
}
```

---

## ‚ö†Ô∏è Tratamento de Erros

Todos os endpoints retornam respostas estruturadas em caso de erro.

### 400 Bad Request - Valida√ß√£o

Ocorre quando os dados enviados n√£o passam nas valida√ß√µes.

**Exemplo - Campo obrigat√≥rio faltando:**
```json
{
  "type": "https://tools.ietf.org/html/rfc9110#section-15.5.1",
  "title": "One or more validation errors occurred.",
  "status": 400,
  "errors": {
    "Name": [
      "The Name field is required."
    ],
    "StartDate": [
      "The StartDate field must be a future date."
    ]
  }
}
```

**Exemplo - Dados inv√°lidos:**
```json
{
  "type": "https://tools.ietf.org/html/rfc9110#section-15.5.1",
  "title": "One or more validation errors occurred.",
  "status": 400,
  "errors": {
    "Phone": [
      "Phone must be between 10 and 15 characters.",
      "Phone must contain only digits and optional '+' prefix."
    ],
    "Department": [
      "Department must be at least 2 characters long."
    ]
  }
}
```

---

### 401 Unauthorized - N√£o Autenticado

Ocorre quando o token JWT n√£o √© fornecido ou √© inv√°lido.

**Response:**
```json
{
  "type": "https://tools.ietf.org/html/rfc9110#section-15.5.2",
  "title": "Unauthorized",
  "status": 401,
  "detail": "Authorization header is missing or invalid token"
}
```

**Causas comuns:**
- Header `Authorization` n√£o enviado
- Token JWT expirado
- Token JWT malformado ou inv√°lido
- Refresh token inv√°lido ou expirado

**Solu√ß√£o:**
1. Fazer login novamente (`POST /api/auth/login`)
2. Ou usar refresh token (`POST /api/auth/refresh`)

---

### 404 Not Found - Recurso N√£o Encontrado

Ocorre quando o recurso solicitado n√£o existe.

**Response:**
```json
{
  "type": "https://tools.ietf.org/html/rfc9110#section-15.5.5",
  "title": "Not Found",
  "status": 404,
  "detail": "Employee with id '3fa85f64-5717-4562-b3fc-2c963f66afa6' not found"
}
```

**Causas comuns:**
- ID do funcion√°rio inv√°lido ou n√£o existe
- Funcion√°rio foi deletado
- Endpoint incorreto

---

### 409 Conflict - Conflito de Dados

Ocorre quando h√° conflito com dados existentes.

**Response:**
```json
{
  "type": "https://tools.ietf.org/html/rfc9110#section-15.5.10",
  "title": "Conflict",
  "status": 409,
  "detail": "User with email 'usuario@example.com' already exists"
}
```

**Causas comuns:**
- Email j√° registrado no sistema
- Dados duplicados

---

### 500 Internal Server Error - Erro Interno

Ocorre quando h√° um erro inesperado no servidor.

**Response:**
```json
{
  "type": "https://tools.ietf.org/html/rfc9110#section-15.6.1",
  "title": "Internal Server Error",
  "status": 500,
  "detail": "An unexpected error occurred. Please try again later."
}
```

**Causas comuns:**
- Erro de conex√£o com banco de dados
- Erro no RabbitMQ
- Erro ao enviar email
- Exce√ß√£o n√£o tratada

**A√ß√£o recomendada:**
- Verificar logs do servidor
- Verificar se todos os servi√ßos (PostgreSQL, RabbitMQ) est√£o rodando
- Tentar novamente ap√≥s alguns segundos

---

## üîî Notifica√ß√µes em Tempo Real (SignalR)

### Conectar ao Hub

**URL:** `ws://localhost:5002/hubs/employee`

**Conex√£o via JavaScript:**
```javascript
const connection = new signalR.HubConnectionBuilder()
    .withUrl("http://localhost:5002/hubs/employee")
    .build();

await connection.start();
```

### Juntar-se a um Grupo (Departamento)

```javascript
await connection.invoke("JoinDepartmentGroup", "TI");
```

### Eventos Recebidos

#### EmployeeCreated
Disparado quando um novo funcion√°rio √© criado.

```javascript
connection.on("ReceiveEmployeeCreated", (notification) => {
    console.log("Novo funcion√°rio:", notification);
});
```

**Payload:**
```json
{
  "employeeId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "employeeName": "Jo√£o Silva Santos",
  "department": "TI",
  "startDate": "2025-11-15T08:00:00Z",
  "eventType": "EmployeeCreated",
  "timestamp": "2025-10-23T10:30:00Z"
}
```

#### EmployeeActivated
Disparado quando um funcion√°rio √© ativado (na data de in√≠cio).

```javascript
connection.on("ReceiveEmployeeActivated", (notification) => {
    console.log("Funcion√°rio ativado:", notification);
});
```

**Payload:**
```json
{
  "employeeId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "employeeName": "Jo√£o Silva Santos",
  "department": "TI",
  "startDate": null,
  "eventType": "EmployeeActivated",
  "timestamp": "2025-11-15T08:00:00Z"
}
```

#### StartDateUpdated
Disparado quando a data de in√≠cio √© alterada.

```javascript
connection.on("ReceiveStartDateUpdated", (notification) => {
    console.log("Data de in√≠cio atualizada:", notification);
});
```

**Payload:**
```json
{
  "employeeId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "employeeName": "Jo√£o Silva Santos",
  "department": "TI",
  "startDate": "2025-12-01T08:00:00Z",
  "eventType": "StartDateUpdated",
  "timestamp": "2025-10-23T15:00:00Z"
}
```

## üß™ Testes

### Testes Unit√°rios
```bash
dotnet test
```

### Testes de Carga
```bash
cd tests/LoadTests
k6 run employee-load-test.js
```

## üîÑ CI/CD

Pipeline configurada com GitHub Actions:
- Build e compila√ß√£o
- Testes unit√°rios
- An√°lise de c√≥digo (SonarQube)
- Build de imagens Docker
- Deploy autom√°tico

## üìö Documenta√ß√£o Adicional

- [STRUCTURE.md](STRUCTURE.md) - Detalhamento da estrutura do projeto
- [TODO.md](TODO.md) - Lista de tarefas e roadmap

## ü§ù Contribuindo

Este projeto √© parte de um desafio t√©cnico para processo seletivo.

## üìÑ Licen√ßa

MIT
